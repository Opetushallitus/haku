<?xml version="1.0" encoding="UTF-8"?>
<project name="haku-deploy" basedir="." >

    <target name="deploy-to-remote-tomcat">
        <!--
        <echo>Backup old haku.war</echo>
        <sshexec command="export DATE=`date +%F_%H-%M-%S`; mkdir $DATE ; cp -rf /data00/tomcat/apache-tomcat-7.0.29/webapps/ROOT $DATE"
                host="${tomcat-host}" username="tomcat" keyfile="${user.home}/.ssh/id_rsa"
                passphrase="" trust="true" failonerror="false" />
        -->

        <condition property="common.properties" value="module-install/server-install/config/integration-test/liferay.user.home/oph-configuration/common.properties">
            <isset property="integration-test" />
        </condition>

        <condition property="common.properties" value="module-install/server-install/config/system-test/liferay.user.home/oph-configuration/common.properties">
            <isset property="system-test" />
        </condition>

        <condition property="config.target" value="/data00/oph/haku/oph-configuration">
            <isset property="integration-test" />
        </condition>

        <condition property="config.target" value="/data00/tomcat/oph-configuration">
            <isset property="system-test" />
        </condition>

        <echo>Stop Tomcat</echo>
        <sshexec command="/etc/init.d/tomcat stop"
                 host="${tomcat-host}" username="tomcat" keyfile="${user.home}/.ssh/id_rsa"
                 passphrase="" trust="true" failonerror="false" />
        <echo>Wait Tomcat to stop...</echo>

        <waitfor maxwait="3000" checkevery="500">
            <not>
                <socket server="${tomcat-host}" port="8282"/>
            </not>
        </waitfor>

        <echo>Tomcat stopped.</echo>

        <echo>Clean Tomcat</echo>
        <sshexec command="rm -rf /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app* /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app /data00/tomcat/apache-tomcat-7.0.29/work/* /data00/tomcat/apache-tomcat-7.0.29/temp/*"
                 host="${tomcat-host}" username="tomcat" keyfile="${user.home}/.ssh/id_rsa"
                 passphrase="" trust="true" failonerror="false" />

        <echo>Copy new haku-app.war</echo>

    	<available file="haku-app/target/haku-app.war"
    	           property="haku.war.path"
    	           value="haku-app/target/haku-app.war" />
    	<available file="target/haku-app.war"
    	           property="haku.war.path"
    	           value="target/haku-app.war" />
    	
	   	<scp file="${haku.war.path}"	
	         todir="tomcat@${tomcat-host}:/data00/tomcat/apache-tomcat-7.0.29/webapps/"
	         keyfile="${user.home}/.ssh/id_rsa"
	         />

        <echo>rename haku-app.war as ROOT</echo>
        <sshexec command="rm -rf /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app;
        mkdir /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app;
        unzip -qo -d/data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app.war;
        rm -rf /data00/tomcat/apache-tomcat-7.0.29/webapps/haku-app.war"
                 host="${tomcat-host}" username="tomcat" keyfile="${user.home}/.ssh/id_rsa"
                 passphrase="" trust="true" failonerror="false" />

        <echo>copy common.properties</echo>
        <scp file="${common.properties}"
             todir="tomcat@${tomcat-host}:${config.target}"
             keyfile="${user.home}/.ssh/id_rsa"
             />

        <echo>Start Tomcat</echo>
        <sshexec command="/etc/init.d/tomcat start"
                 host="${tomcat-host}" username="tomcat" keyfile="${user.home}/.ssh/id_rsa"
                 passphrase="" trust="true" failonerror="false" />

        <echo>Successfully deployed haku-app.war to ${tomcat-host}</echo>
    </target>

</project>