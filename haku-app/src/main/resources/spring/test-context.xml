<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright (c) 2012 The Finnish Board of Education - Opetushallitus
  ~
  ~ This program is free software:  Licensed under the EUPL, Version 1.1 or - as
  ~ soon as they will be approved by the European Commission - subsequent versions
  ~ of the EUPL (the "Licence");
  ~
  ~ You may not use this work except in compliance with the Licence.
  ~ You may obtain a copy of the Licence at: http://www.osor.eu/eupl/
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ European Union Public Licence for more details.
  -->

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:task="http://www.springframework.org/schema/task"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
        http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <beans>
        <bean class="fi.vm.sade.haku.LoggerConfigurer">
            <constructor-arg><value>config/it/log4j.properties</value></constructor-arg>
        </bean>

        <context:property-placeholder
                location="classpath:config/it/haku.properties, classpath:config/it/ext.properties, classpath:haku-test.properties"
                ignore-resource-not-found="true" properties-ref="itProps"/>
        <bean id="itProps" class="org.springframework.beans.factory.config.PropertiesFactoryBean"/>
        <import resource="logger-mock-context.xml"/>
        <!--<import resource="form-login-security-context.xml"/>-->

        <context:annotation-config/>

        <context:component-scan
                base-package="fi.vm.sade.haku,fi.vm.sade.security,fi.vm.sade.organisaatio.service.search"/>
        <aop:aspectj-autoproxy/>

        <bean id="yksilointiScheduler" class="fi.vm.sade.haku.oppija.postprocess.Scheduler">
            <property name="run" value="${scheduler.run}"/>
            <property name="runModelUpgrade" value="${scheduler.runModelUpgrade}"/>
            <property name="runEligibilityCheck" value="${scheduler.runEligibilityCheck}"/>
            <property name="sendMail" value="${scheduler.sendMail}"/>
        </bean>
        
        <task:scheduler id="postProcessScheduler" pool-size="1"/>
        <task:scheduled-tasks scheduler="postProcessScheduler">
            <task:scheduled ref="yksilointiScheduler" method="runProcess" fixed-delay="${scheduler.delay}"/>
            <task:scheduled ref="yksilointiScheduler" method="redoPostprocess" fixed-delay="${scheduler.delay}"/>
        </task:scheduled-tasks>

        <task:scheduler id="identificationScheduler" pool-size="1"/>
        <task:scheduled-tasks scheduler="identificationScheduler">
            <task:scheduled ref="yksilointiScheduler" method="runIdentification" fixed-delay="${scheduler.delay}"/>
        </task:scheduled-tasks>

        <task:scheduler id="upgradeScheduler" pool-size="1"/>
        <task:scheduled-tasks scheduler="upgradeScheduler">
            <task:scheduled ref="yksilointiScheduler" method="runModelUpgrade" cron="${scheduler.modelUpgradeCron}"/>
        </task:scheduled-tasks>

        <task:scheduler id="eligibilityCheckScheduler" pool-size="1"/>
        <task:scheduled-tasks scheduler="eligibilityCheckScheduler">
            <task:scheduled ref="yksilointiScheduler" method="runEligibilityCheck" cron="${scheduler.eligibilityCheckCron}"/>
        </task:scheduled-tasks>

        <!-- Swagger stuff -->
        <bean id="apiListingResourceJSON" class="com.wordnik.swagger.jersey.listing.ApiListingResourceJSON"/>
        <bean id="apiDeclarationProvider" class="com.wordnik.swagger.jersey.listing.JerseyApiDeclarationProvider" scope="singleton"/>
        <bean id="resourceListingProvider" class="com.wordnik.swagger.jersey.listing.JerseyResourceListingProvider" scope="singleton"/>
        
        <bean id="beanConfig" class="com.wordnik.swagger.jaxrs.config.BeanConfig">
            <property name="title" value="Haku App"/>
            <property name="version" value="1.0.0" />
            <property name="basePath" value="https://${host.virkailija}/haku-app"/>
            <property name="resourcePackage" value="fi.vm.sade.haku.oppija.hakemus.resource"/>
            <property name="scan" value="true"/>
        </bean>
    </beans>

</beans>
